<!-- Floating Action Button (FAB) -->
<button 
  class="widget-fab"
  [class.hidden]="isOpen() && !isMinimized()"
  (click)="toggleWidget()"
  matTooltip="Context Fill - Auto-fill forms with AI"
  matTooltipPosition="left"
>
  <div class="fab-content">
    <mat-icon>auto_fix_high</mat-icon>
    @if (filledFieldsCount() > 0) {
      <span class="fab-badge">{{ filledFieldsCount() }}</span>
    }
  </div>
</button>

<!-- Widget Panel -->
<div 
  class="widget-panel"
  [class.open]="isOpen()"
  [class.minimized]="isMinimized()"
>
  <!-- Header -->
  <div class="widget-header">
    <div class="header-title">
      <mat-icon>auto_fix_high</mat-icon>
      <span>Context Fill</span>
    </div>
    <div class="header-actions">
      <button mat-icon-button (click)="minimizeWidget()" matTooltip="Minimize">
        <mat-icon>remove</mat-icon>
      </button>
      <button mat-icon-button (click)="closeWidget()" matTooltip="Close">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Content -->
  <div class="widget-content">
    <!-- Form Selection -->
    <div class="section">
      <div class="section-label">
        <mat-icon>description</mat-icon>
        <span>Target Form</span>
      </div>
      
      @if (detectedForms().length > 0) {
        <mat-form-field appearance="outline" class="form-select">
          <mat-select 
            [value]="selectedFormId()" 
            (selectionChange)="selectedFormId.set($event.value)"
          >
            @for (form of detectedForms(); track form.id) {
              <mat-option [value]="form.id">
                {{ form.name }} ({{ form.fields.length }} fields)
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
        
        @if (selectedForm()) {
          <div class="form-fields-preview">
            <span class="fields-label">Fields:</span>
            <div class="fields-chips">
              @for (field of selectedForm()!.fields.slice(0, 5); track field) {
                <span class="field-chip">{{ field }}</span>
              }
              @if (selectedForm()!.fields.length > 5) {
                <span class="field-chip more">+{{ selectedForm()!.fields.length - 5 }} more</span>
              }
            </div>
          </div>
        }
      } @else {
        <div class="no-forms">
          <mat-icon>search_off</mat-icon>
          <span>No forms detected on this page</span>
        </div>
      }
    </div>

    <mat-divider></mat-divider>

    <!-- Document Upload -->
    <div class="section">
      <div class="section-label">
        <mat-icon>upload_file</mat-icon>
        <span>Document</span>
      </div>

      @if (!hasFile()) {
        <div 
          class="drop-zone"
          [class.drag-over]="isDragOver()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="triggerFileInput()"
        >
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <span class="drop-text">Drop file or click to browse</span>
          <span class="drop-hint">Images or PDF (max 10MB)</span>
        </div>
        <input 
          #fileInput 
          type="file" 
          hidden 
          accept=".jpg,.jpeg,.png,.gif,.webp,.pdf"
          (change)="onFileSelect($event)"
        />
      } @else {
        <div class="file-preview">
          <div class="file-info">
            <mat-icon class="file-icon">
              {{ uploadedFile()?.type === 'application/pdf' ? 'picture_as_pdf' : 'image' }}
            </mat-icon>
            <div class="file-details">
              <span class="file-name">{{ uploadedFile()?.name }}</span>
              <span class="file-size">{{ formatFileSize(uploadedFile()?.size || 0) }}</span>
            </div>
            <button mat-icon-button (click)="removeFile()" class="remove-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          
          @if (isProcessing()) {
            <mat-progress-bar 
              mode="determinate" 
              [value]="processingProgress()"
              class="progress-bar"
            ></mat-progress-bar>
            <span class="processing-text">Extracting with AI...</span>
          }
          
          @if (hasExtractedData() && filledFieldsCount() > 0) {
            <div class="success-message">
              <mat-icon>check_circle</mat-icon>
              <span>Filled {{ filledFieldsCount() }} field(s)</span>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Footer -->
  <div class="widget-footer">
    <button 
      mat-flat-button 
      color="primary"
      class="fill-button"
      [disabled]="!hasFile() || !selectedFormId() || isProcessing()"
      (click)="extractAndFill()"
    >
      @if (isProcessing()) {
        <ng-container><mat-icon class="spin">autorenew</mat-icon></ng-container>
        Processing...
      } @else {
        <ng-container><mat-icon>auto_fix_high</mat-icon></ng-container>
        Extract & Fill
      }
    </button>
  </div>
</div>
